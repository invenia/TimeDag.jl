<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Internals · TimeDag.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://invenia.github.io/TimeDag.jl/reference/internals/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img class="docs-light-only" src="../../assets/logo.png" alt="TimeDag.jl logo"/><img class="docs-dark-only" src="../../assets/logo-dark.png" alt="TimeDag.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">TimeDag.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../concepts/">Concepts</a></li><li><a class="tocitem" href="../../examples/">Examples</a></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="../fundamentals/">Fundamentals</a></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Nodes</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../align/">Alignment</a></li><li><a class="tocitem" href="../arithmetic/">Arithmetic</a></li><li><a class="tocitem" href="../online_windowed/">Online &amp; windowed</a></li><li><a class="tocitem" href="../sources/">Sources</a></li></ul></li><li><a class="tocitem" href="../creating_ops/">Creating operations</a></li><li class="is-active"><a class="tocitem" href>Internals</a><ul class="internal"><li><a class="tocitem" href="#Identity-map"><span>Identity map</span></a></li><li><a class="tocitem" href="#Advanced-evaluation"><span>Advanced evaluation</span></a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Reference</a></li><li class="is-active"><a href>Internals</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Internals</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/invenia/TimeDag.jl/blob/master/docs/src/reference/internals.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Internals"><a class="docs-heading-anchor" href="#Internals">Internals</a><a id="Internals-1"></a><a class="docs-heading-anchor-permalink" href="#Internals" title="Permalink"></a></h1><p>This page documents internal, and less commonly-used API. Some of it will be useful for users for more advanced use-cases, like running graphs in production systems. Other parts shouldn&#39;t need to be regularly interacted with, but can be useful to know about.</p><h2 id="Identity-map"><a class="docs-heading-anchor" href="#Identity-map">Identity map</a><a id="Identity-map-1"></a><a class="docs-heading-anchor-permalink" href="#Identity-map" title="Permalink"></a></h2><p>One of the key features of <code>TimeDag.jl</code> is avoiding duplicating work.</p><p>This is primarily achieved by ensuring that we never construct the &#39;same&#39; node twice. By &#39;same&#39;, here we mean two nodes that we can prove will always give the same output.</p><p>One easy-to-handle case is that of a node that has identical parents &amp; op to another. To avoid this, <code>TimeDag.jl</code> maintains a global <a href="https://en.wikipedia.org/wiki/Identity_map_pattern">identity map</a>, of type <a href="#TimeDag.IdentityMap"><code>TimeDag.IdentityMap</code></a>.</p><p>Currently the only implementation of the identity map is <a href="#TimeDag.WeakIdentityMap"><code>TimeDag.WeakIdentityMap</code></a>. This contains weak references to nodes, to ensure that we know about all nodes that currently exist, but don&#39;t unnecessarily prevent nodes from being garbage collected when we no longer want them.</p><p>In practice, all nodes should be constructed indirectly using <a href="../fundamentals/#TimeDag.obtain_node"><code>TimeDag.obtain_node</code></a>.  This will query the <code>global_identity_map()</code>, and only construct a new node if an equivalent one does not already exist.</p><article class="docstring"><header><a class="docstring-binding" id="TimeDag.IdentityMap" href="#TimeDag.IdentityMap"><code>TimeDag.IdentityMap</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">IdentityMap</code></pre><p>An abstract identity map.</p><p>Any implementation of this type needs to implement <a href="#TimeDag.obtain_node!"><code>obtain_node!</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/invenia/TimeDag.jl/blob/2e6bd369da997c622f092b023b766d78ae571b35/src/identity_map.jl#L33-L39">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="TimeDag.obtain_node!" href="#TimeDag.obtain_node!"><code>TimeDag.obtain_node!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">obtain_node!(id_map::IdentityMap, parents::NTuple{N,Node}, op::NodeOp) -&gt; Node</code></pre><p>If a node with <code>parents</code> and <code>op</code> doesn&#39;t exist inside <code>id_map</code>, create and insert it.</p><p>Return either the new or existing node.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/invenia/TimeDag.jl/blob/2e6bd369da997c622f092b023b766d78ae571b35/src/identity_map.jl#L122-L128">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="TimeDag.global_identity_map" href="#TimeDag.global_identity_map"><code>TimeDag.global_identity_map</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">global_identity_map() -&gt; IdentityMap</code></pre><p>Get the global IdentityMap instance used in TimeDag.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/invenia/TimeDag.jl/blob/2e6bd369da997c622f092b023b766d78ae571b35/src/identity_map.jl#L158-L162">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="TimeDag.WeakNode" href="#TimeDag.WeakNode"><code>TimeDag.WeakNode</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">WeakNode(parents, op)</code></pre><p>Represent a node-like object that doesn&#39;t hold strong references to its parents.</p><p>This exists purely such that <code>hash</code> and <code>==</code> <em>do</em> allow multiple instances of <code>WeakNode</code> to compare equal if they have the same <code>parents</code> and <code>op</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/invenia/TimeDag.jl/blob/2e6bd369da997c622f092b023b766d78ae571b35/src/identity_map.jl#L12-L19">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="TimeDag.WeakIdentityMap" href="#TimeDag.WeakIdentityMap"><code>TimeDag.WeakIdentityMap</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">WeakIdentityMap</code></pre><p>Represent a collection of nodes which doesn&#39;t hold strong references to any nodes.</p><p>This is useful, as it allows the existence of this cache to be somewhat transparent to the user, and they only have to care about holding on to references for nodes that they care about.</p><p>This structure contains nodes, but also node weak nodes – these allow us to determine whether we ought to create a given node.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/invenia/TimeDag.jl/blob/2e6bd369da997c622f092b023b766d78ae571b35/src/identity_map.jl#L42-L53">source</a></section></article><h2 id="Advanced-evaluation"><a class="docs-heading-anchor" href="#Advanced-evaluation">Advanced evaluation</a><a id="Advanced-evaluation-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced-evaluation" title="Permalink"></a></h2><p>Sometimes <a href="../fundamentals/#TimeDag.evaluate"><code>evaluate</code></a> does not provide enough control. This section goes into more detail about how evaluation works, and in particular how this can be useful for live systems.</p><h3 id="Evaluation-state"><a class="docs-heading-anchor" href="#Evaluation-state">Evaluation state</a><a id="Evaluation-state-1"></a><a class="docs-heading-anchor-permalink" href="#Evaluation-state" title="Permalink"></a></h3><h3 id="Batching"><a class="docs-heading-anchor" href="#Batching">Batching</a><a id="Batching-1"></a><a class="docs-heading-anchor-permalink" href="#Batching" title="Permalink"></a></h3><h3 id="Scheduling"><a class="docs-heading-anchor" href="#Scheduling">Scheduling</a><a id="Scheduling-1"></a><a class="docs-heading-anchor-permalink" href="#Scheduling" title="Permalink"></a></h3><article class="docstring"><header><a class="docstring-binding" id="TimeDag.EvaluationState" href="#TimeDag.EvaluationState"><code>TimeDag.EvaluationState</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">EvaluationState</code></pre><p>All state necessary for the evaluation of some nodes.</p><p>This should be created with <a href="#TimeDag.start_at"><code>start_at</code></a>.</p><p><strong>Fields</strong></p><ul><li><code>ordered_node_to_children::OrderedDict{Node,Set{Node}}</code>: a map from every node which we   need to run, to its children. The ordering of the elements is such that, if evaluated in   this order, all dependencies will be evaluated before they are required.</li><li><code>node_to_state::IdDict{Node,NodeEvaluationState}</code>: maintain the state for every node   being evaluated.</li><li><code>current_time::DateTime</code>: the time to which this state corresponds.</li><li><code>evaluated_node_to_blocks::IdDict{Node,Vector{Block}}</code>: the output blocks that we care   about.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/invenia/TimeDag.jl/blob/2e6bd369da997c622f092b023b766d78ae571b35/src/evaluation.jl#L1-L17">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="TimeDag.NodeEvaluationState" href="#TimeDag.NodeEvaluationState"><code>TimeDag.NodeEvaluationState</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">abstract type NodeEvaluationState end</code></pre><p>Represents any and all state that a node must retain between evaluating batches.</p><p>Instances of subtypes of <code>NodeEvaluationState</code> are given to <a href="#TimeDag.run_node!"><code>run_node!</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/invenia/TimeDag.jl/blob/2e6bd369da997c622f092b023b766d78ae571b35/src/core.jl#L47-L53">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="TimeDag.start_at" href="#TimeDag.start_at"><code>TimeDag.start_at</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">start_at(nodes, time_start::DateTime) -&gt; EvaluationState</code></pre><p>Create a sufficient <a href="#TimeDag.EvaluationState"><code>EvaluationState</code></a> for the evaluation of <code>nodes</code>.</p><p>Internally, this will determine the subgraph that needs evaluating, i.e. all the ancestors of <code>nodes</code>, and create a <a href="#TimeDag.NodeEvaluationState"><code>NodeEvaluationState</code></a> for each of these.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/invenia/TimeDag.jl/blob/2e6bd369da997c622f092b023b766d78ae571b35/src/evaluation.jl#L47-L54">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="TimeDag.get_up_to!" href="#TimeDag.get_up_to!"><code>TimeDag.get_up_to!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">get_up_to!(state::EvaluationState, time_end::DateTime)</code></pre><p>Update the evaluation state by performing the evalution for each node.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/invenia/TimeDag.jl/blob/2e6bd369da997c622f092b023b766d78ae571b35/src/evaluation.jl#L77-L81">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="TimeDag.run_node!" href="#TimeDag.run_node!"><code>TimeDag.run_node!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">run_node!(
    state::NodeEvaluationState,
    op::NodeOp{T},
    time_start::DateTime,
    time_end::DateTime,
    input_blocks::Block...
) -&gt; Block{T}</code></pre><p>Evaluate the given node from <code>time_start</code> to <code>time_end</code>, with the initial <code>state</code>. Zero or more blocks will be passed as an input; these correspond to the parents of a node, and are passed in the same order as that returned by <code>parents(node)</code>.</p><p>We return a new <code>Block</code> of output knots from this node.</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>The implementer of <code>run_node!</code> must ensure that no future peeking occurs. That is, that no output knot is dependent on input knots that occur subsequently.</p></div></div></div><a class="docs-sourcelink" target="_blank" href="https://github.com/invenia/TimeDag.jl/blob/2e6bd369da997c622f092b023b766d78ae571b35/src/core.jl#L86-L104">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../creating_ops/">« Creating operations</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.5 on <span class="colophon-date" title="Friday 29 October 2021 16:37">Friday 29 October 2021</span>. Using Julia version 1.6.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
